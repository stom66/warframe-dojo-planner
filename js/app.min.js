// Written by stom@stom66.co.uk
var snap_size=20,rotate_angle_snap=22.5,canvas_width=$("#dojo_canvas_parent").width(),canvas_height=$("#dojo_canvas_parent").height(),zoomLevel=0,zoomLevelMin=-7,zoomLevelMax=0,panning=!1,clean_slate=!0,base_url=[location.protocol,"//",location.host,location.pathname].join(""),room_count=0,power_count=0,capacity_count=0,categories=[];$.each(tiles.map(function(a){return a[1]}),function(a,b){-1===$.inArray(b,categories)&&categories.push(b)}),canvas_max_wh=canvas_width>canvas_height?canvas_width:canvas_height;var canvas=new fabric.Canvas("dojo_canvas",{selection:!0,height:canvas_height,width:canvas_width,hoverCursor:"move",moveCursor:"move"});canvas.on("object:moving",function(a){a.target.set({left:Math.round(a.target.left/snap_size)*snap_size,top:Math.round(a.target.top/snap_size)*snap_size})}),canvas.on("object:rotating",function(a){a.target.angle=Math.round(a.target.angle/rotate_angle_snap)*rotate_angle_snap}),canvas.on({"touch:gesture":function(a){if(a.e.touches&&2==a.e.touches.length){pausePanning=!0;var b=new fabric.Point(a.self.x,a.self.y);"start"==a.self.state&&(zoomStartScale=self.canvas.getZoom());var c=zoomStartScale*a.self.scale;self.canvas.zoomToPoint(b,c),pausePanning=!1}},"object:selected":function(){pausePanning=!0},"selection:cleared":function(){pausePanning=!1},"touch:drag":function(a){if(!1==pausePanning&&void 0!=a.e.layerX&&void 0!=a.e.layerY){if(currentX=a.e.layerX,currentY=a.e.layerY,xChange=currentX-lastX,yChange=currentY-lastY,50>=Math.abs(currentX-lastX)&&50>=Math.abs(currentY-lastY)){var b=new fabric.Point(xChange,yChange);canvas.relativePan(b)}lastX=a.e.layerX,lastY=a.e.layerY}}});function canvas_addTile(a,b,c){b&&c||(topRight=canvas_getVisibleCorner("tr"),b=topRight.x-tiles[a][3]-50,c=topRight.y+50),fabric.loadSVGFromURL(tiles[a][0],function(d,f){var g=fabric.util.groupSVGElements(d,f);g.set({left:b,top:c,width:tiles[a][3],height:tiles[a][4],hasBorders:!0,hasControls:!0,lockScalingFlip:!0,borderColor:"#fff",dojo_cap:tiles[a][5],dojo_power:tiles[a][6],dojo_room:!0}),g.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,tr:!1,tl:!1,br:!1,bl:!1,mtr:!0}),g.scaleToWidth(tiles[a][3]),g.scaleToHeight(tiles[a][4]),canvas.add(g),canvas.renderAll(),gui_dojoStats(1,tiles[a][6],tiles[a][5])})}function canvas_addIcon(a=1,b,c){b&&c||(topRight=canvas_getVisibleCorner("tr"),b=topRight.x-20,c=topRight.y+20);var d=new fabric.Text(fontAwesomeIcons[a][1],{left:b,top:c,fill:"white",originX:"right",originY:"top",fontSize:60,fontFamily:"FontAwesome",fontWeight:500});canvas.add(d)}function canvas_addIconSVG(a=1,b,c){b&&c||(topRight=canvas_getVisibleCorner("tr"),b=topRight.x-20,c=topRight.y+20);var d=new fabric.Path(fontAwesomeIcons[a][2],{left:b,top:c,originX:"right",originY:"top",height:100,width:100,flipX:!0,flipY:!0,hasBorders:!0,hasControls:!0,lockScalingFlip:!0,scaleX:0.1,scaleY:0.1,fill:"white",stroke:"white"});canvas.add(d)}function canvas_addLabel(a="Enter text",b,c){b&&c||(topRight=canvas_getVisibleCorner("tr"),b=topRight.x-20,c=topRight.y+20);var d=new fabric.IText(a,{left:b,top:c,fill:"white",originX:"right",originY:"top",fontSize:100,fontFamily:"Open Sans Condensed"});canvas.add(d)}function canvas_addImageFromURL(a,b,c){fabric.Image.fromURL(a,function(d){b&&c||(topRight=canvas_getVisibleCorner("tr"),b=topRight.x-20,c=topRight.y+20),d.set({left:b-d.width,top:c,originX:"right",originY:"top"}),canvas.add(d),$("#modal_import_image").modal("hide")})}function canvas_addImageFromSrc(a,b,c){b&&c||(topRight=canvas_getVisibleCorner("tr"),b=topRight.x-20,c=topRight.y+20);var d=new fabric.Image(a);d.set({left:b-a.width,top:c,originX:"right",originY:"top",angle:0}),canvas.add(d),$("#modal_import_image").modal("hide")}function canvas_ungroupObjects(a){var b=a.destroy(),c=b.getObjects();c.forEach(function(d){canvas.add(d)}),canvas.remove(a)}function canvas_removeObject(a){console.log("Clem shall slay ",a),canvas.remove(a),console.log("It is done."),gui_reCalcDojoStats(),canvas.renderAll()}function canvas_getVisibleCorner(a){var b=[];return b.y=canvas.calcViewportBoundaries()[a].y,b.x=canvas.calcViewportBoundaries()[a].x,b}function canvas_cloneObject(a,b){a.clone(function(d){canvas.discardActiveObject(),d.set({left:d.left+b,top:d.top,evented:!0}),"group"==a.type&&d.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,tr:!1,tl:!1,br:!1,bl:!1,mtr:!0}),"activeSelection"===d.type?(d.canvas=canvas,d.forEachObject(function(f){canvas.add(f)}),d.setCoords()):canvas.add(d),canvas.setActiveObject(d),canvas.requestRenderAll(),console.log("Clem underwent mitosis and produced a ",a.type)},["left","top","hasBorders","hasControls","dojo_room","dojo_cap","dojo_power","borderColor","lockScalingFlip"]),gui_reCalcDojoStats()}function changeColor(a,b){console.log("Clem paints the walls in "+a),b&&"activeSelection"!==b.get("type")&&(console.log("type: "+b.get("type")),console.log(b),b._objects&&b._objects.forEach(function(c){if(-1!==c.fill.indexOf("rgba"))var d=c.fill.split(",")[c.fill.split(",").length-1].slice(0,-1);else d=1;"rgba(0,0,0,0.5)"!==c.fill&&0<d&&(console.log("Clem is painting path ",c),c.fill=a)}),b.set({fill:a,color:a,fillColor:a}),canvas_cloneObject(b,0),canvas_removeObject(b))}function zoomIn(a){zoomLevel<zoomLevelMax&&(zoomLevel++,canvas.zoomToPoint(a,Math.pow(1.5,zoomLevel)),console.log("Clem sets his vision to "+zoomLevel+", and has a target: ",a))}function zoomOut(a){zoomLevel>zoomLevelMin&&(zoomLevel--,canvas.zoomToPoint(a,Math.pow(1.5,zoomLevel)),console.log("Clem sets his vision to "+zoomLevel+", and has a target: ",a))}function canvas_scrollZoom(a){if(-1<navigator.userAgent.toLowerCase().indexOf("firefox")){var b=-a.originalEvent.detail;console.log("Clem spies burning kubrow")}else var b=a.originalEvent.wheelDelta;if(0!=b){console.log("Clem points to ",a.originalEvent.offsetX,a.originalEvent.offsetY);var c=new fabric.Point(a.originalEvent.offsetX,a.originalEvent.offsetY);0<b?zoomIn(c):0>b&&zoomOut(c)}}$("#dojo_canvas_parent").bind("contextmenu",function(a){console.log("Clem leans to the right"),console.log(a);var b=new fabric.Point(a.originalEvent.offsetX,a.originalEvent.offsetY);return canvas.getObjects().forEach(function(c){c.containsPoint(b)&&(console.log("Clem found a shiny!",c),canvas_removeObject(c))}),a.preventDefault(),!1}),jQuery("html").on("DOMMouseScroll",function(a){canvas_scrollZoom(a)}),jQuery(".canvas-container").on("mousewheel",function(a){canvas_scrollZoom(a)});function startPan(a){function b(g){var h=g.screenX,j=g.screenY;canvas.relativePan({x:h-2*Math.round(d/2),y:j-Math.round(2*(f/2))}),d=h,f=j}function c(g){$(window).off("mousemove",b),$(window).off("mouseup",c);var h=g.screenX,j=g.screenY;canvas.relativePan({x:h-Math.round(d/(snap_size/2))*(snap_size/2),y:j-Math.round(f/(snap_size/2)*(snap_size/2))}),console.log("Clem gets up again"),console.log("(Cause youre never gonna keep Clem down)")}if(1===a.button){console.log("Clem gets knocked down");var d=a.screenX,f=a.screenY;$(window).mousemove(b),$(window).mouseup(c),$(window).contextmenu(cancelMenu)}}function cancelMenu(){return $(window).off("contextmenu",cancelMenu),!1}$("#dojo_canvas_parent").mousedown(startPan),$(document).keydown(function(a){var b=a.which;if(null!==canvas.getActiveObject()){var d=canvas.getActiveObject(),f=d.get("type");if(console.log("Clem is looking at an",f),"activeSelection"==f){var g=d;console.log("Clem is looking at a group!",g)}}if(!(0<=$.inArray(b,[67,68,82,37,38,39,40]))||d.isEditing)console.log("Clem does not recognise this symbol",a.which);else if(d||g)switch(b){case 67:canvas.getActiveObject().clone(function(k){_clipboard=k},["left","hasBorders","hasControls","dojo_room","dojo_cap","dojo_power","borderColor","lockScalingFlip"]),canvas_cloneObject(_clipboard,d.width);break;case 68:"activeSelection"===f?confirm("Delete this group of "+d._objects.length+" items?")&&(g.getObjects().forEach(function(k){canvas_removeObject(k)}),canvas.discardActiveGroup()):canvas_removeObject(d);break;case 82:console.log("Clem spins right round, like record");var j=d.angle+90;d.rotate(j),canvas.requestRenderAll();break;case 37:console.log("Clem shuggles left"),d.set({left:d.left-snap_size}),d.setCoords(),canvas.renderAll();break;case 38:console.log("Clem shuggles up"),d.set({top:d.top-snap_size}),d.setCoords(),canvas.renderAll();break;case 39:console.log("Clem shuggles right"),d.set({left:d.left+snap_size}),d.setCoords(),canvas.renderAll();break;case 40:console.log("Clem shuggles down"),d.set({top:d.top+snap_size}),d.setCoords(),canvas.renderAll();}});function gui_addNavbarCategories(){categories.forEach(function(a,b){$("#top_nav").append("<li class=\"nav-item dropdown\" id=\"top_nav_cat_"+b+"\"><a class=\"nav-link dropdown-toggle\" href=\"#\" id=\"navbarDropdown"+a+"\" role=\"button\" data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">"+a+"</a><div class=\"dropdown-menu dropdown-menu-right\" aria-labelledby=\"navbarDropdown\"></div></li>")})}function gui_addNavbarTiles(){categories.forEach(function(a,b){tiles.forEach(function(c,d){c[1]==a&&$("#top_nav_cat_"+b+" > div").append("<a class=\"dropdown-item\" onclick=\"canvas_addTile("+d+")\">"+c[2]+"</a>")})})}function gui_addNavbarIcons(){fontAwesomeIcons.forEach(function(b,c){$("#top_nav_cat_markers").append("<a class=\"dropdown-item\" onclick=\"canvas_addIconSVG("+c+")\"><i class=\"fa "+b[0]+"\"></i></a>")})}function pastebinMessage(a,b,c){if(messages=[["fa-exclamation-triangle","Error!","btn-danger"],["fa-check","Copied!","btn-success"]],$("#gui_btn_pastebin").html("<i class=\"fa "+messages[a][0]+" mr-1\"></i> "+messages[a][1]+"").toggleClass(messages[a][2]),1==a){var d=base_url+"?p="+c;$("#output_p_link a").attr("href",d),$("#output_p_link a").text(d),$("#output_p_link span").text(""),$("#output_p_link").hasClass("hide")&&$("#output_p_link").toggleClass("hide show")}else $("#output_p_link a").attr("href","#"),$("#output_p_link a").text(""),$("#output_p_link span").text(b),$("#output_p_link").hasClass("hide")&&$("#output_p_link").toggleClass("hide show");setTimeout(function(){$("#gui_btn_pastebin").toggleClass(messages[a][2])&&($("#gui_btn_pastebin").toggleClass("btn-default"),$("#gui_btn_pastebin").html("Import"))},3e3)}function gui_dojoStats(a,b,c){Number.isInteger(a)&&Number.isInteger(b)&&Number.isInteger(c)?(console.log("Clem takes stock of his surroundings and yells, '"+a+" "+b+" "+c+"!'"),room_count+=a,power_count+=b,capacity_count+=c,$("#room_count").html(room_count),$("#power_count").html(power_count),$("#capacity_count").html(capacity_count),1>room_count?$("#room_count_wrapper").addClass("text-danger text-strong"):$("#room_count_wrapper").removeClass("text-danger text-strong"),1>power_count?$("#power_count_wrapper").addClass("text-danger text-strong"):$("#power_count_wrapper").removeClass("text-danger text-strong"),1>capacity_count?$("#capacity_count_wrapper").addClass("text-danger text-strong"):$("#capacity_count_wrapper").removeClass("text-danger text-strong")):console.log("Clem looks around, then starts scremaing for his NaN")}function gui_reCalcDojoStats(){room_count=0,capacity_count=0,power_count=0,canvas.getObjects().forEach(function(a){if(a.get("dojo_room")){var b=a.get("dojo_cap"),c=a.get("dojo_power");gui_dojoStats(1,c,b)}})}function clearTextareaInput(){$("#textarea_data_input").text(""),$("#textarea_data_input").val("")}function copyToClipboard(a){$(a).select(),document.execCommand("copy")?($("#gui_btn_copy_data").html("<i class=\"fa fa-check mr-1\"></i> Copied!"),$("#gui_btn_copy_data").removeClass("btn-primary").addClass("btn-success")):($("#gui_btn_copy_data").html("<i class=\"fa fa-exclamation-triangle mr-1\"></i> Error!"),$("#gui_btn_copy_data").removeClass("btn-primary").addClass("btn-danger"))}$("#gui_btn_load_data").click(function(){loadData()}),$("#gui_btn_modal_save").click(function(){saveData()}),$("#gui_btn_zoom_out").click(function(){var a=new fabric.Point(canvas_width/2,canvas_height/2);zoomOut(a)}),$("#gui_btn_zoom_in").click(function(){var a=new fabric.Point(canvas_width/2,canvas_height/2);zoomIn(a)}),$("#gui_btn_grid_toggle").click(function(){$(this).toggleClass("btn-primary btn-secondary"),$("#gui_btn_grid_toggle > i").toggleClass("fa-square-o fa-plus-square-o"),$("canvas").toggleClass("grid")}),$("#gui_btn_add_text").click(function(){canvas_addLabel()}),$("#modal_instructions").on("shown.bs.modal",function(){console.log("Clem rummages through his inventory to see what tools he has for the job ahead.")}),$("#modal_instructions").on("hidden.bs.modal",function(){console.log("Reassured, he heads off on his journey.")}),$("#modal_about").on("shown.bs.modal",function(){console.log("Clem reads the label on his backpack. 'Hand wash only' Clem does not know what this means.")}),$("#modal_about").on("hidden.bs.modal",function(){console.log("Clem figures its probably okay to ginore it.")}),$("#input_color").spectrum({color:"#6aa84f",showInput:!0,className:"full-spectrum",showInitial:!0,showPalette:!0,showSelectionPalette:!0,maxSelectionSize:10,preferredFormat:"hex",localStorageKey:"spectrum.demo",move:function(a){var b=a.toHexString(),c=canvas.getActiveObject();changeColor(b,c)},show:function(){},beforeShow:function(){},hide:function(){},change:function(){},palette:[["rgb(0, 0, 0)","rgb(67, 67, 67)","rgb(102, 102, 102)","rgb(204, 204, 204)","rgb(217, 217, 217)","rgb(255, 255, 255)"],["rgb(152, 0, 0)","rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(74, 134, 232)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],["rgb(230, 184, 175)","rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(201, 218, 248)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)","rgb(221, 126, 107)","rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(164, 194, 244)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)","rgb(204, 65, 37)","rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(109, 158, 235)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)","rgb(166, 28, 0)","rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(60, 120, 216)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)","rgb(91, 15, 0)","rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(28, 69, 135)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]]}),$("#gui_btn_copy_data").click(function(){copyToClipboard("#textarea_data")}),$("#gui_btn_clear_data_input").click(function(){clearTextareaInput()}),$("#gui_btn_pastebin").click(function(){loadPasteBin($("#input_pastebin").val())}),$("#gui_btn_import_file").click(function(){import_json()}),$("#gui_btn_import_image").click(function(){var a=$("#input_image_url").val();return a?void canvas_addImageFromURL(a):($("#gui_btn_import_image").toggleClass("btn-warning").text("No url!"),setTimeout(function(){$("#gui_btn_import_image").toggleClass("btn-warning").text("Import")},1e3),!1)});function loadData(){var a=JSON.parse($("#textarea_data_input").val());clearTextareaInput(),canvas.clear(),power_count=0,room_count=0,capacity_count=0,canvas.loadFromDatalessJSON(a,function(){canvas.renderAll(),canvas.getObjects().forEach(function(b){b.get("dojo_room")&&b.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,tr:!1,tl:!1,br:!1,bl:!1,mtr:!0})}),gui_reCalcDojoStats(),saveData(),setTimeout(function(){$("#modal_load").modal("hide")},1700)})}function saveData(){var b=JSON.stringify(canvas.toJSON(["dojo_power","dojo_room","dojo_cap"])),c="data:text/json;charset=utf-8,"+encodeURIComponent(b);$("#gui_btn_download_json").attr("href",c),$("#gui_btn_download_json").attr("download","dojo_layout.json");var d=canvas.toSVG({});$("#gui_btn_download_svg").attr("href","data:image/svg+xml;charset=utf-8,"+d),$("#gui_btn_download_svg").attr("download","dojo_layout.svg");var g=canvas.toDataURL({});$("#gui_btn_download_png").attr("href",g),$("#gui_btn_download_png").attr("download","dojo_layout.png"),$("#textarea_data").text(b),$("#gui_btn_copy_data").hasClass("btn-success")&&($("#gui_btn_copy_data").toggleClass("btn-primary btn-success"),$("#gui_btn_copy_data").text("Copy"))}function loadPasteBin(a){var b=a.split("/").pop();8===b.length?(console.log("Clem tries to paste "+b),$.ajax({url:"https://pastebin.com/raw/"+b,dataType:"json",success:function(d){console.log("Clem is victorious. ",d),pastebinMessage(1,"Copied!",b);var f=JSON.stringify(d);$("#textarea_data_input").val(f),loadData()},error:function(d,f){console.log("Clem fails. "+f+" | ",d);pastebinMessage(0,"There was a problem getting the paste, usually due to CORS. Try saving the paste as a json file and uploading it.",b)}})):(pastebinMessage(0,"Error! Couldn't find a valid Pastebin",b),console.log("Clem cant paste with ",b))}$("#input_json_file").change(function(){var a=new FileReader;a.onload=function(){$("#textarea_data_input").val(a.result),console.log("Once upon a Clem...",a.result),setTimeout(function(){loadData()},1500)};var b=$("#input_json_file").prop("files")[0];a.readAsText(b)}),$("#input_image_file").change(function(){var a=new FileReader;a.onload=function(c){var d=new Image;d.src=c.target.result,d.onload=function(){canvas_addImageFromSrc(d),console.log("Clem has uncovered an artefact...",d)}};var b=$("#input_image_file").prop("files")[0];a.readAsDataURL(b)});function getUrlVars(){for(var b,a=[],c=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),d=0;d<c.length;d++)b=c[d].split("="),a.push(b[0]),a[b[0]]=b[1];return a}getUrlVars().pastebin&&(console.log("Clem fetches "+getUrlVars().pastebin),loadPasteBin(getUrlVars().pastebin),clean_slate=!1),getUrlVars().p&&(console.log("Clem fetches "+getUrlVars().p),loadPasteBin(getUrlVars().p),clean_slate=!1);function preloadImages(){tiles.forEach(function(a){$("<img/>")[0].src=a[0]})}$(function(){console.log(" __   \n(_  _ \n__)(_) began the tale of Clem the Mighty..."),gui_addNavbarCategories(),gui_addNavbarTiles(),gui_addNavbarIcons(),$("[data-placement=\"bottom\"]").tooltip();var a=new fabric.Point(canvas_width/2,canvas_height/2);zoomOut(a),clean_slate&&($("#modal_instructions").modal("show"),canvas_addTile(0,canvas_width/2-tiles[0][3]/2,canvas_height/2-tiles[0][4]/2))});